name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOSTINGER_IP }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: 22
          script: |
            cd ~/public_html

            echo "ğŸ“ Aktuelles Verzeichnis: $(pwd)"
            echo "â¡ï¸ Hole neusten Code von GitHub..."
            git pull origin main

            echo "ğŸ” PrÃ¼fe kritische Dateien..."
            test -f public/index.php || (echo "âŒ index.php fehlt!" && exit 1)
            test -f public/.htaccess || (echo "âŒ .htaccess fehlt!" && exit 1)

            echo "ğŸ§° PrÃ¼fe ob npm verfÃ¼gbar ist..."
            if ! command -v npm &> /dev/null; then
              echo "ğŸ“¦ npm nicht gefunden â€“ versuche Node.js zu installieren..."
              curl -O https://nodejs.org/dist/v18.19.1/node-v18.19.1-linux-x64.tar.xz
              tar -xf node-v18.19.1-linux-x64.tar.xz
              mv node-v18.19.1-linux-x64 ~/nodejs
              export PATH=$HOME/nodejs/bin:$PATH
              echo 'export PATH=$HOME/nodejs/bin:$PATH' >> ~/.bashrc
              source ~/.bashrc
            fi

            echo "ğŸ“¦ Installiere PHP-AbhÃ¤ngigkeiten (Composer Ã¼ber Benutzerpfad)..."
            ~/composer install --no-dev --optimize-autoloader

            echo "ğŸ”§ Baue Assets mit npm..."
            if command -v npm &> /dev/null; then
              npm ci
              npm run build
            else
              echo "âš ï¸ npm weiterhin nicht verfÃ¼gbar â€“ Build wird Ã¼bersprungen"
            fi

            echo "ğŸ”„ FÃ¼hre Laravel-Befehle aus..."
            php artisan migrate --force || echo "Migration skipped"
            php artisan config:cache || echo "Config cache skipped"
            php artisan route:cache || echo "Route cache skipped"

            echo "âœ… Deployment abgeschlossen."
