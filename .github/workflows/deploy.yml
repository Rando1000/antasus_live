name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            cd domains/antasus.de/public_html

            echo "ğŸ“ Aktuelles Verzeichnis: $(pwd)"
            echo "â¡ï¸ Hole neusten Code von GitHub..."
            git reset --hard
            git clean -fd
            git pull origin main --rebase

            echo "ğŸ” PrÃ¼fe kritische Dateien..."
            test -f public/index.php || (echo "âŒ index.php fehlt!" && exit 1)
            test -f public/.htaccess || (echo "âŒ .htaccess fehlt!" && exit 1)

            echo "ğŸ§° PrÃ¼fe ob node & npm verfÃ¼gbar sind..."
            if ! command -v node &> /dev/null || ! command -v npm &> /dev/null; then
              echo "ğŸ“¦ Node.js oder npm nicht gefunden â€“ installiere..."
              curl -O https://nodejs.org/dist/v18.19.1/node-v18.19.1-linux-x64.tar.gz
              tar -xzf node-v18.19.1-linux-x64.tar.gz
              mv node-v18.19.1-linux-x64 nodejs
              echo 'export PATH=$HOME/nodejs/bin:$PATH' >> ~/.bashrc
              source ~/.bashrc

            echo "ğŸ“¦ Installiere PHP-AbhÃ¤ngigkeiten (Composer Ã¼ber Benutzerpfad)..."
            ~/composer install --no-dev --optimize-autoloader

            echo "ğŸ”§ Baue Assets mit npm..."
            npm ci
            npm run build

            echo "ğŸ§ª Laravel Commands ausfÃ¼hren (ohne Datenverlust)..."
            php artisan config:cache
            php artisan route:cache || echo "âš ï¸ Routen-Caching Ã¼bersprungen"
            php artisan migrate --force || echo "âš ï¸ Migration Ã¼bersprungen"

            echo "âœ… Deployment abgeschlossen â€“ teste Seite..."
            curl -sSf https://www.antasus.de || (echo "âŒ Seite nicht erreichbar!" && exit 1)
